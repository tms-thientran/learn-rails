#!/usr/bin/env ruby
require "fileutils"

# Quick setup script for Kamal deployment

def check_command(command)
  system("which #{command} > /dev/null 2>&1")
end

puts "ğŸš€ Kamal Deployment Setup"
puts "=" * 50

# Check requirements
puts "\n1ï¸âƒ£ Checking requirements..."
missing = []
missing << "docker" unless check_command("docker")
missing << "kamal" unless check_command("kamal")

if missing.any?
  puts "âŒ Missing: #{missing.join(', ')}"
  puts "\nInstall kamal: gem install kamal"
  exit 1
else
  puts "âœ… All requirements met"
end

# Check for config/master.key
unless File.exist?("config/master.key")
  puts "\nâŒ config/master.key not found!"
  puts "Run: bin/rails credentials:edit"
  exit 1
end

# Create .kamal directory
puts "\n2ï¸âƒ£ Setting up .kamal directory..."
FileUtils.mkdir_p(".kamal")
puts "âœ… Created .kamal/"

# Copy secrets example if not exists
if File.exist?(".kamal/secrets")
  puts "âš ï¸  .kamal/secrets already exists"
else
  if File.exist?(".kamal/secrets.example")
    FileUtils.cp(".kamal/secrets.example", ".kamal/secrets")
    puts "âœ… Created .kamal/secrets from template"
  end
end

puts "\n3ï¸âƒ£ Things you need to do manually:"
puts ""
puts "ğŸ“ Edit config/deploy.yml:"
puts "   - Replace YOUR_SERVER_IP with your server IP (3 places)"
puts "   - Replace YOUR_GITHUB_USERNAME (2 places)"
puts ""
puts "ğŸ“ Edit .kamal/secrets:"
puts "   - Add your GitHub Personal Access Token"
puts "   - Add your MySQL password"
puts ""
puts "ğŸ”‘ Create GitHub Personal Access Token:"
puts "   1. Go to: https://github.com/settings/tokens"
puts "   2. Generate new token (classic)"
puts "   3. Select scopes: write:packages, read:packages"
puts ""

puts "\n4ï¸âƒ£ After completing the above, run:"
puts ""
puts "   # Check config"
puts "   kamal config"
puts ""
puts "   # Deploy!"
puts "   kamal setup"
puts ""

puts "ğŸ“– For detailed instructions, see: DEPLOY.md"
puts "=" * 50

