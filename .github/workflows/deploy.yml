name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Cho phÃ©p trigger thá»§ cÃ´ng

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/learn-rails

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set lowercase image name
        id: image
        run: echo "name=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract short SHA
        id: sha
        run: echo "short=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:latest
            ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ steps.sha.outputs.short }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:buildcache,mode=max

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4.7'
          bundler-cache: true

      - name: Cache Kamal gem
        uses: actions/cache@v3
        with:
          path: vendor/kamal
          key: kamal-${{ runner.os }}-v1

      - name: Install Kamal
        run: gem install kamal --no-document

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Create Kamal secrets file
        run: |
          mkdir -p .kamal
          cat > .kamal/secrets << EOF
          # Generated by GitHub Actions
          RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }}
          KAMAL_REGISTRY_PASSWORD=${{ secrets.GITHUB_TOKEN }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          EOF
          chmod 600 .kamal/secrets

      - name: Update deploy.yml to use deploy_key
        run: |
          sed -i 's|~/.ssh/nnoc-nail.pem|~/.ssh/deploy_key|g' config/deploy.yml

      - name: Verify Kamal config
        run: bin/kamal config

      - name: Deploy with Kamal
        run: bin/kamal deploy --skip-push

      - name: Health check
        run: |
          echo "â³ Waiting for app to be ready..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf http://${{ secrets.SERVER_IP }}/up > /dev/null; then
              echo "âœ… App is healthy!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "â³ Attempt $attempt/$max_attempts..."
            sleep 5
          done
          echo "âš ï¸ Health check timeout, but container may still be starting"
          exit 0

      - name: Show deployment status
        if: always()
        run: bin/kamal app details || true

      - name: Notify on success
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ Deploy thÃ nh cÃ´ng!"
          echo "=========================================="
          echo "ğŸŒ URL: http://${{ secrets.SERVER_IP }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ By: ${{ github.actor }}"
          echo "=========================================="

      - name: Notify on failure
        if: failure()
        run: |
          echo "=========================================="
          echo "âŒ Deploy tháº¥t báº¡i!"
          echo "=========================================="
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ By: ${{ github.actor }}"
          echo "ğŸ’¡ Check logs above for details"
          echo "=========================================="

